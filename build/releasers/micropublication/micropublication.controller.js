'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.release = undefined;

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var cov_27caz4pvrq = function () {
  var path = '/Users/rawbin/Documents/Projets/collaborations/ensad-publishing/prototype/plurishing-backend/src/releasers/micropublication/micropublication.controller.js',
      hash = '140c0479b880a15708effd554da492e4370a0883',
      global = new Function('return this')(),
      gcv = '__coverage__',
      coverageData = {
    path: '/Users/rawbin/Documents/Projets/collaborations/ensad-publishing/prototype/plurishing-backend/src/releasers/micropublication/micropublication.controller.js',
    statementMap: {
      '0': {
        start: {
          line: 26,
          column: 4
        },
        end: {
          line: 26,
          column: 15
        }
      },
      '1': {
        start: {
          line: 28,
          column: 22
        },
        end: {
          line: 33,
          column: 1
        }
      },
      '2': {
        start: {
          line: 35,
          column: 19
        },
        end: {
          line: 40,
          column: 1
        }
      },
      '3': {
        start: {
          line: 45,
          column: 29
        },
        end: {
          line: 57,
          column: 1
        }
      },
      '4': {
        start: {
          line: 46,
          column: 16
        },
        end: {
          line: 46,
          column: 69
        }
      },
      '5': {
        start: {
          line: 47,
          column: 2
        },
        end: {
          line: 55,
          column: 3
        }
      },
      '6': {
        start: {
          line: 48,
          column: 4
        },
        end: {
          line: 54,
          column: 41
        }
      },
      '7': {
        start: {
          line: 56,
          column: 2
        },
        end: {
          line: 56,
          column: 12
        }
      },
      '8': {
        start: {
          line: 59,
          column: 23
        },
        end: {
          line: 139,
          column: 1
        }
      },
      '9': {
        start: {
          line: 60,
          column: 2
        },
        end: {
          line: 138,
          column: 5
        }
      },
      '10': {
        start: {
          line: 63,
          column: 17
        },
        end: {
          line: 63,
          column: 19
        }
      },
      '11': {
        start: {
          line: 65,
          column: 4
        },
        end: {
          line: 137,
          column: 19
        }
      },
      '12': {
        start: {
          line: 69,
          column: 8
        },
        end: {
          line: 69,
          column: 30
        }
      },
      '13': {
        start: {
          line: 70,
          column: 30
        },
        end: {
          line: 70,
          column: 64
        }
      },
      '14': {
        start: {
          line: 71,
          column: 8
        },
        end: {
          line: 71,
          column: 66
        }
      },
      '15': {
        start: {
          line: 75,
          column: 6
        },
        end: {
          line: 75,
          column: 36
        }
      },
      '16': {
        start: {
          line: 76,
          column: 24
        },
        end: {
          line: 76,
          column: 41
        }
      },
      '17': {
        start: {
          line: 77,
          column: 6
        },
        end: {
          line: 84,
          column: 7
        }
      },
      '18': {
        start: {
          line: 83,
          column: 8
        },
        end: {
          line: 83,
          column: 33
        }
      },
      '19': {
        start: {
          line: 88,
          column: 25
        },
        end: {
          line: 88,
          column: 27
        }
      },
      '20': {
        start: {
          line: 90,
          column: 6
        },
        end: {
          line: 110,
          column: 7
        }
      },
      '21': {
        start: {
          line: 91,
          column: 21
        },
        end: {
          line: 91,
          column: 54
        }
      },
      '22': {
        start: {
          line: 92,
          column: 24
        },
        end: {
          line: 92,
          column: 72
        }
      },
      '23': {
        start: {
          line: 93,
          column: 21
        },
        end: {
          line: 93,
          column: 41
        }
      },
      '24': {
        start: {
          line: 94,
          column: 8
        },
        end: {
          line: 109,
          column: 10
        }
      },
      '25': {
        start: {
          line: 96,
          column: 12
        },
        end: {
          line: 107,
          column: 14
        }
      },
      '26': {
        start: {
          line: 97,
          column: 14
        },
        end: {
          line: 106,
          column: 15
        }
      },
      '27': {
        start: {
          line: 98,
          column: 16
        },
        end: {
          line: 98,
          column: 32
        }
      },
      '28': {
        start: {
          line: 100,
          column: 16
        },
        end: {
          line: 105,
          column: 30
        }
      },
      '29': {
        start: {
          line: 102,
          column: 20
        },
        end: {
          line: 102,
          column: 53
        }
      },
      '30': {
        start: {
          line: 103,
          column: 20
        },
        end: {
          line: 103,
          column: 40
        }
      },
      '31': {
        start: {
          line: 111,
          column: 6
        },
        end: {
          line: 111,
          column: 37
        }
      },
      '32': {
        start: {
          line: 116,
          column: 22
        },
        end: {
          line: 116,
          column: 50
        }
      },
      '33': {
        start: {
          line: 117,
          column: 25
        },
        end: {
          line: 133,
          column: 8
        }
      },
      '34': {
        start: {
          line: 120,
          column: 8
        },
        end: {
          line: 132,
          column: 9
        }
      },
      '35': {
        start: {
          line: 123,
          column: 12
        },
        end: {
          line: 123,
          column: 73
        }
      },
      '36': {
        start: {
          line: 124,
          column: 12
        },
        end: {
          line: 124,
          column: 55
        }
      },
      '37': {
        start: {
          line: 127,
          column: 12
        },
        end: {
          line: 127,
          column: 83
        }
      },
      '38': {
        start: {
          line: 128,
          column: 12
        },
        end: {
          line: 128,
          column: 50
        }
      },
      '39': {
        start: {
          line: 131,
          column: 12
        },
        end: {
          line: 131,
          column: 37
        }
      },
      '40': {
        start: {
          line: 134,
          column: 6
        },
        end: {
          line: 134,
          column: 37
        }
      }
    },
    fnMap: {
      '0': {
        name: '(anonymous_0)',
        decl: {
          start: {
            line: 45,
            column: 29
          },
          end: {
            line: 45,
            column: 30
          }
        },
        loc: {
          start: {
            line: 45,
            column: 44
          },
          end: {
            line: 57,
            column: 1
          }
        },
        line: 45
      },
      '1': {
        name: '(anonymous_1)',
        decl: {
          start: {
            line: 59,
            column: 23
          },
          end: {
            line: 59,
            column: 24
          }
        },
        loc: {
          start: {
            line: 59,
            column: 38
          },
          end: {
            line: 139,
            column: 1
          }
        },
        line: 59
      },
      '2': {
        name: '(anonymous_2)',
        decl: {
          start: {
            line: 60,
            column: 22
          },
          end: {
            line: 60,
            column: 23
          }
        },
        loc: {
          start: {
            line: 60,
            column: 43
          },
          end: {
            line: 138,
            column: 3
          }
        },
        line: 60
      },
      '3': {
        name: '(anonymous_3)',
        decl: {
          start: {
            line: 68,
            column: 12
          },
          end: {
            line: 68,
            column: 13
          }
        },
        loc: {
          start: {
            line: 68,
            column: 27
          },
          end: {
            line: 72,
            column: 7
          }
        },
        line: 68
      },
      '4': {
        name: '(anonymous_4)',
        decl: {
          start: {
            line: 74,
            column: 10
          },
          end: {
            line: 74,
            column: 11
          }
        },
        loc: {
          start: {
            line: 74,
            column: 29
          },
          end: {
            line: 85,
            column: 5
          }
        },
        line: 74
      },
      '5': {
        name: '(anonymous_5)',
        decl: {
          start: {
            line: 87,
            column: 10
          },
          end: {
            line: 87,
            column: 11
          }
        },
        loc: {
          start: {
            line: 87,
            column: 16
          },
          end: {
            line: 112,
            column: 5
          }
        },
        line: 87
      },
      '6': {
        name: '(anonymous_6)',
        decl: {
          start: {
            line: 95,
            column: 22
          },
          end: {
            line: 95,
            column: 23
          }
        },
        loc: {
          start: {
            line: 96,
            column: 12
          },
          end: {
            line: 107,
            column: 14
          }
        },
        line: 96
      },
      '7': {
        name: '(anonymous_7)',
        decl: {
          start: {
            line: 96,
            column: 33
          },
          end: {
            line: 96,
            column: 34
          }
        },
        loc: {
          start: {
            line: 96,
            column: 40
          },
          end: {
            line: 107,
            column: 13
          }
        },
        line: 96
      },
      '8': {
        name: '(anonymous_8)',
        decl: {
          start: {
            line: 101,
            column: 24
          },
          end: {
            line: 101,
            column: 25
          }
        },
        loc: {
          start: {
            line: 101,
            column: 34
          },
          end: {
            line: 104,
            column: 19
          }
        },
        line: 101
      },
      '9': {
        name: '(anonymous_9)',
        decl: {
          start: {
            line: 114,
            column: 10
          },
          end: {
            line: 114,
            column: 11
          }
        },
        loc: {
          start: {
            line: 114,
            column: 16
          },
          end: {
            line: 135,
            column: 5
          }
        },
        line: 114
      },
      '10': {
        name: '(anonymous_10)',
        decl: {
          start: {
            line: 117,
            column: 37
          },
          end: {
            line: 117,
            column: 38
          }
        },
        loc: {
          start: {
            line: 117,
            column: 49
          },
          end: {
            line: 133,
            column: 7
          }
        },
        line: 117
      }
    },
    branchMap: {
      '0': {
        loc: {
          start: {
            line: 46,
            column: 16
          },
          end: {
            line: 46,
            column: 69
          }
        },
        type: 'binary-expr',
        locations: [{
          start: {
            line: 46,
            column: 16
          },
          end: {
            line: 46,
            column: 27
          }
        }, {
          start: {
            line: 46,
            column: 31
          },
          end: {
            line: 46,
            column: 69
          }
        }],
        line: 46
      },
      '1': {
        loc: {
          start: {
            line: 47,
            column: 2
          },
          end: {
            line: 55,
            column: 3
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 47,
            column: 2
          },
          end: {
            line: 55,
            column: 3
          }
        }, {
          start: {
            line: 47,
            column: 2
          },
          end: {
            line: 55,
            column: 3
          }
        }],
        line: 47
      },
      '2': {
        loc: {
          start: {
            line: 77,
            column: 6
          },
          end: {
            line: 84,
            column: 7
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 77,
            column: 6
          },
          end: {
            line: 84,
            column: 7
          }
        }, {
          start: {
            line: 77,
            column: 6
          },
          end: {
            line: 84,
            column: 7
          }
        }],
        line: 77
      },
      '3': {
        loc: {
          start: {
            line: 90,
            column: 6
          },
          end: {
            line: 110,
            column: 7
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 90,
            column: 6
          },
          end: {
            line: 110,
            column: 7
          }
        }, {
          start: {
            line: 90,
            column: 6
          },
          end: {
            line: 110,
            column: 7
          }
        }],
        line: 90
      },
      '4': {
        loc: {
          start: {
            line: 90,
            column: 10
          },
          end: {
            line: 90,
            column: 95
          }
        },
        type: 'binary-expr',
        locations: [{
          start: {
            line: 90,
            column: 10
          },
          end: {
            line: 90,
            column: 39
          }
        }, {
          start: {
            line: 90,
            column: 43
          },
          end: {
            line: 90,
            column: 95
          }
        }],
        line: 90
      },
      '5': {
        loc: {
          start: {
            line: 97,
            column: 14
          },
          end: {
            line: 106,
            column: 15
          }
        },
        type: 'if',
        locations: [{
          start: {
            line: 97,
            column: 14
          },
          end: {
            line: 106,
            column: 15
          }
        }, {
          start: {
            line: 97,
            column: 14
          },
          end: {
            line: 106,
            column: 15
          }
        }],
        line: 97
      },
      '6': {
        loc: {
          start: {
            line: 120,
            column: 8
          },
          end: {
            line: 132,
            column: 9
          }
        },
        type: 'switch',
        locations: [{
          start: {
            line: 122,
            column: 10
          },
          end: {
            line: 124,
            column: 55
          }
        }, {
          start: {
            line: 126,
            column: 10
          },
          end: {
            line: 128,
            column: 50
          }
        }, {
          start: {
            line: 129,
            column: 10
          },
          end: {
            line: 129,
            column: 26
          }
        }, {
          start: {
            line: 130,
            column: 10
          },
          end: {
            line: 131,
            column: 37
          }
        }],
        line: 120
      }
    },
    s: {
      '0': 0,
      '1': 0,
      '2': 0,
      '3': 0,
      '4': 0,
      '5': 0,
      '6': 0,
      '7': 0,
      '8': 0,
      '9': 0,
      '10': 0,
      '11': 0,
      '12': 0,
      '13': 0,
      '14': 0,
      '15': 0,
      '16': 0,
      '17': 0,
      '18': 0,
      '19': 0,
      '20': 0,
      '21': 0,
      '22': 0,
      '23': 0,
      '24': 0,
      '25': 0,
      '26': 0,
      '27': 0,
      '28': 0,
      '29': 0,
      '30': 0,
      '31': 0,
      '32': 0,
      '33': 0,
      '34': 0,
      '35': 0,
      '36': 0,
      '37': 0,
      '38': 0,
      '39': 0,
      '40': 0
    },
    f: {
      '0': 0,
      '1': 0,
      '2': 0,
      '3': 0,
      '4': 0,
      '5': 0,
      '6': 0,
      '7': 0,
      '8': 0,
      '9': 0,
      '10': 0
    },
    b: {
      '0': [0, 0],
      '1': [0, 0],
      '2': [0, 0],
      '3': [0, 0],
      '4': [0, 0],
      '5': [0, 0],
      '6': [0, 0, 0, 0]
    },
    _coverageSchema: '332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'
  },
      coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  coverageData.hash = hash;
  return coverage[path] = coverageData;
}();

var _path = require('path');

var _fsExtra = require('fs-extra');

var _uuid = require('uuid');

var _montages = require('../../components/montages');

var _compositions = require('../../components/compositions');

var _html2img = require('../../services/html2img');

var _twitter = require('../twitter');

var _mailing = require('../mailing');

var _config = require('../../utils/config');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _ref = (cov_27caz4pvrq.s[0]++, (0, _config.getConfig)()),
    twitter_consumer_key = _ref.twitter_consumer_key,
    twitter_consumer_secret = _ref.twitter_consumer_secret,
    twitter_access_token = _ref.twitter_access_token,
    twitter_access_token_secret = _ref.twitter_access_token_secret,
    smtpService = _ref.smtpService,
    smtpEmail = _ref.smtpEmail,
    smtpPassword = _ref.smtpPassword,
    mailingHubEmail = _ref.mailingHubEmail;

var twitterConfig = (cov_27caz4pvrq.s[1]++, {
  consumer_key: twitter_consumer_key,
  consumer_secret: twitter_consumer_secret,
  access_token: twitter_access_token,
  access_token_secret: twitter_access_token_secret
});

var mailConfig = (cov_27caz4pvrq.s[2]++, {
  smtp_service: smtpService,
  smtp_password: smtpPassword,
  smtp_email: smtpEmail,
  mailing_hub_email: mailingHubEmail
});

/**
 * @todo refactor as shared util
 */
cov_27caz4pvrq.s[3]++;
var renderAbstractAsHtml = function renderAbstractAsHtml(composition) {
  cov_27caz4pvrq.f[0]++;

  var abstr = (cov_27caz4pvrq.s[4]++, (cov_27caz4pvrq.b[0][0]++, composition) && (cov_27caz4pvrq.b[0][1]++, composition.metadata.abstract_original));
  cov_27caz4pvrq.s[5]++;
  if (abstr) {
    cov_27caz4pvrq.b[1][0]++;
    cov_27caz4pvrq.s[6]++;

    return '<html>\n    <head>\n      <style>\n        *{background: white; color: black;}\n      </style>\n    </head>\n    <body><p>' + abstr + '</p></body></html>';
  } else {
    cov_27caz4pvrq.b[1][1]++;
  }
  cov_27caz4pvrq.s[7]++;
  return '';
};

cov_27caz4pvrq.s[8]++;
var release = exports.release = function release(diffusion) {
  cov_27caz4pvrq.f[1]++;
  cov_27caz4pvrq.s[9]++;

  return new _promise2.default(function (resolve, reject) {
    cov_27caz4pvrq.f[2]++;

    var montage = void 0;
    var composition = void 0;
    var assets = (cov_27caz4pvrq.s[10]++, {});
    // fetch montage
    cov_27caz4pvrq.s[11]++;
    _montages.dal.getMontage({ id: diffusion.montage_id })
    // fetch composition demendency
    .then(function (thatMontage) {
      cov_27caz4pvrq.f[3]++;
      cov_27caz4pvrq.s[12]++;

      montage = thatMontage;
      var compositionId = (cov_27caz4pvrq.s[13]++, montage.data.target_composition_id);
      cov_27caz4pvrq.s[14]++;
      return _compositions.dal.getComposition({ id: compositionId });
    })
    // fetch resource dependencies
    .then(function (thatComposition) {
      cov_27caz4pvrq.f[4]++;
      cov_27caz4pvrq.s[15]++;

      composition = thatComposition;
      var resources = (cov_27caz4pvrq.s[16]++, montage.resources);
      cov_27caz4pvrq.s[17]++;
      if (resources) {
        // do stuff to fetch them
        /**
         * @todo implement resource fetching when adding resources images in micropublication
         */

        cov_27caz4pvrq.b[2][0]++;
      } else {
        cov_27caz4pvrq.b[2][1]++;
        cov_27caz4pvrq.s[18]++;

        return _promise2.default.resolve();
      }
    })
    // fetch assets dependencies
    .then(function () {
      cov_27caz4pvrq.f[5]++;

      var operations = (cov_27caz4pvrq.s[19]++, []);
      // produce abstract image ?
      cov_27caz4pvrq.s[20]++;
      if ((cov_27caz4pvrq.b[4][0]++, montage.data.include_abstract) && (cov_27caz4pvrq.b[4][1]++, diffusion.parameters.targets.indexOf('twitter') > -1)) {
        cov_27caz4pvrq.b[3][0]++;

        var html = (cov_27caz4pvrq.s[21]++, renderAbstractAsHtml(composition));
        var absPath = (cov_27caz4pvrq.s[22]++, __dirname + '/../../../temp/' + (0, _uuid.v4)() + '.jpg');
        var path = (cov_27caz4pvrq.s[23]++, (0, _path.resolve)(absPath));
        cov_27caz4pvrq.s[24]++;
        operations.push(new _promise2.default(function (reso, rej) {
          cov_27caz4pvrq.f[6]++;
          cov_27caz4pvrq.s[25]++;
          return (/* eslint promise/param-names : 0 */
            (0, _html2img.service)(html, path, function (err) {
              cov_27caz4pvrq.f[7]++;
              cov_27caz4pvrq.s[26]++;

              if (err) {
                cov_27caz4pvrq.b[5][0]++;
                cov_27caz4pvrq.s[27]++;

                return rej(err);
              } else {
                cov_27caz4pvrq.b[5][1]++;
                cov_27caz4pvrq.s[28]++;

                (0, _fsExtra.readFile)(path, 'base64').then(function (base64) {
                  cov_27caz4pvrq.f[8]++;
                  cov_27caz4pvrq.s[29]++;

                  assets.abstractImageUri = base64;
                  cov_27caz4pvrq.s[30]++;
                  return (0, _fsExtra.remove)(path);
                }).then(reso);
              }
            })
          );
        }));
      } else {
        cov_27caz4pvrq.b[3][1]++;
      }
      cov_27caz4pvrq.s[31]++;
      return _promise2.default.all(operations);
    })
    // register release operations to perform
    .then(function () {
      cov_27caz4pvrq.f[9]++;

      // execute
      var targets = (cov_27caz4pvrq.s[32]++, diffusion.parameters.targets);
      var operations = (cov_27caz4pvrq.s[33]++, targets.map(function (targetId) {
        cov_27caz4pvrq.f[10]++;

        var tweetContents = void 0;
        var mailContents = void 0;
        cov_27caz4pvrq.s[34]++;
        switch (targetId) {

          case 'twitter':
            cov_27caz4pvrq.b[6][0]++;
            cov_27caz4pvrq.s[35]++;

            tweetContents = (0, _twitter.montageToTweet)(montage, composition, assets);
            cov_27caz4pvrq.s[36]++;
            return (0, _twitter.tweet)(tweetContents, twitterConfig);

          case 'mailing':
            cov_27caz4pvrq.b[6][1]++;
            cov_27caz4pvrq.s[37]++;

            mailContents = (0, _mailing.montageToMail)(montage, composition, assets, mailConfig);
            cov_27caz4pvrq.s[38]++;
            return (0, _mailing.mail)(mailContents, mailConfig);
          case 'facebook':
            cov_27caz4pvrq.b[6][2]++;

          default:
            cov_27caz4pvrq.b[6][3]++;
            cov_27caz4pvrq.s[39]++;

            return _promise2.default.resolve();
        }
      }));
      cov_27caz4pvrq.s[40]++;
      return _promise2.default.all(operations);
    }).then(resolve).catch(reject);
  });
};